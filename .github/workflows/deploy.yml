name: Deploy Infrastructure & Services

on:
  push:
    branches: [main]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

env:
  TF_VAR_gcp_project_id: ${{ secrets.GCP_PROJECT_ID }}
  TF_VAR_gcp_region: ${{ secrets.GCP_REGION }}
  TF_VAR_bnet_client_id: ${{ secrets.BNET_CLIENT_ID }}
  TF_VAR_bnet_client_secret: ${{ secrets.BNET_CLIENT_SECRET }}
  TF_VAR_database_password: ${{ secrets.DATABASE_PASSWORD }}
  TF_VAR_session_secret: ${{ secrets.SESSION_SECRET }}
  TF_VAR_frontend_url: ${{ secrets.FRONTEND_URL }}
  TF_VAR_github_repo: ${{ github.repository }}

jobs:
  deploy:
    name: Terraform Apply & Cloud Run Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.5"

      - name: Configure Terraform GCS Backend
        working-directory: terraform
        run: |
          cat > backend.tf <<EOF
          terraform {
            backend "gcs" {
              bucket = "${{ secrets.TF_STATE_BUCKET }}"
              prefix = "terraform/state"
            }
          }
          EOF

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve

      - name: Get addon artifacts bucket name
        id: addon-bucket
        working-directory: terraform
        run: |
          BUCKET_NAME=$(terraform output -raw addon_artifacts_bucket_name)
          echo "bucket_name=$BUCKET_NAME" >> "$GITHUB_OUTPUT"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install backend dependencies
        run: npm ci --workspace=backend

      - name: Get Cloud SQL connection name
        id: cloud-sql
        working-directory: terraform
        run: |
          CONNECTION_NAME=$(terraform output -raw cloud_sql_connection_name)
          echo "connection_name=$CONNECTION_NAME" >> "$GITHUB_OUTPUT"

      - name: Run database migration and seed
        run: |
          curl -fsSL -o cloud-sql-proxy \
            https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.14.3/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy
          ./cloud-sql-proxy "${{ steps.cloud-sql.outputs.connection_name }}" --port 5432 &
          PROXY_PID=$!
          sleep 3
          npm run migrate --workspace=backend
          npm run seed --workspace=backend
          kill $PROXY_PID || true
        env:
          DATABASE_URL: postgresql://wow_app:${{ secrets.DATABASE_PASSWORD }}@127.0.0.1:5432/wow_professions

      - name: Package and upload addon artifact
        run: |
          ADDON_VERSION=$(awk -F': ' '/^## Version:/ {print $2}' addon/ProfessionExporter/ProfessionExporter.toc | tr -d '\r')
          if [ -z "$ADDON_VERSION" ]; then
            ADDON_VERSION="${GITHUB_SHA::7}"
          fi

          ARTIFACT_NAME="ProfessionExporter-${ADDON_VERSION}.zip"
          (cd addon && zip -r "../$ARTIFACT_NAME" ProfessionExporter -x "*.DS_Store")

          BUCKET="${{ steps.addon-bucket.outputs.bucket_name }}"
          gcloud storage cp "$ARTIFACT_NAME" "gs://${BUCKET}/releases/${ADDON_VERSION}/$ARTIFACT_NAME"
          gcloud storage cp "$ARTIFACT_NAME" "gs://${BUCKET}/latest/ProfessionExporter.zip"

          echo "Addon release URL: https://storage.googleapis.com/${BUCKET}/releases/${ADDON_VERSION}/$ARTIFACT_NAME"
          echo "Addon latest URL: https://storage.googleapis.com/${BUCKET}/latest/ProfessionExporter.zip"

      - name: Deploy Backend to Cloud Run
        run: |
          gcloud run deploy wow-professions-api \
            --source ./backend \
            --region ${{ secrets.GCP_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }} \
            --quiet

      - name: Get Backend URL
        id: backend-url
        run: |
          URL=$(gcloud run services describe wow-professions-api \
            --region ${{ secrets.GCP_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }} \
            --format 'value(status.url)')
          echo "url=$URL" >> "$GITHUB_OUTPUT"

      - name: Deploy Frontend to Cloud Run
        run: |
          gcloud run deploy wow-professions-web \
            --source ./frontend \
            --region ${{ secrets.GCP_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }} \
            --set-build-env-vars "VITE_API_URL=${{ steps.backend-url.outputs.url }},VITE_ADDON_DOWNLOAD_URL=https://storage.googleapis.com/${{ steps.addon-bucket.outputs.bucket_name }}/latest/ProfessionExporter.zip" \
            --quiet
